<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Records – Jyotiba Finance Group</title>

<style>
body{
  margin:0;
  font-family: system-ui, Arial, sans-serif;
  background:#f4f6f8;
}
header{
  background:#1565c0;
  color:#fff;
  padding:14px;
  text-align:center;
  font-size:20px;
  font-weight:700;
}
.container{
  padding:14px;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
}
input{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-bottom:8px;
}
.btn{
  display:inline-block;
  padding:8px 12px;
  border-radius:10px;
  background:#1565c0;
  color:#fff;
  text-decoration:none;
  font-weight:600;
  margin-right:6px;
}
.row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.list-item{
  display:flex;
  justify-content:space-between;
  padding:12px 0;
  border-bottom:1px solid #eee;
}

/* ---- Daily Status Colors ---- */
.not-paid{
  background:#fff4f4;
  border-left:5px solid #d32f2f;
  padding-left:8px;
}
.paid{
  background:#f1f8f4;
  border-left:5px solid #2e7d32;
  padding-left:8px;
}

/* ---- Badges ---- */
.badge{
  display:inline-block;
  padding:2px 8px;
  font-size:11px;
  border-radius:10px;
  margin-left:6px;
}
.badge-red{
  background:#d32f2f;
  color:#fff;
}
.badge-green{
  background:#2e7d32;
  color:#fff;
}

.small{
  color:#666;
  font-size:14px;
}
.total{
  font-size:22px;
  font-weight:700;
  color:#1565c0;
}
</style>
</head>

<body>

<header>Jyotiba Finance Group</header>

<div class="container">

  <!-- Filters -->
  <div class="card">
    <div class="small">Filters</div>

    <input type="date" id="fromDate">
    <input type="date" id="toDate">
    <input type="text" id="borrower" placeholder="Borrower name">

    <div class="row">
      <button class="btn" onclick="applyFilters()">Apply</button>
      <button class="btn" onclick="resetFilters()">Reset</button>
      <button class="btn" onclick="exportCSV()">Export CSV</button>
      <a class="btn" href="index.html">⬅ Dashboard</a>
    </div>
  </div>

  <!-- Total -->
  <div class="card">
    <div class="small">Cash Received (Filtered)</div>
    <div id="totalAmount" class="total">₹0</div>
  </div>

  <!-- Records -->
  <div class="card">
    <div class="small">Daily Collection Status</div>
    <div id="recordsList"></div>
  </div>

</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRHMVetLYoyRzDg57nOm2drb4pSyw33hqNsOTI9F92rD7bnk2p7sUypioSdhSNH_zcGO75kmsBKM5VI/pub?gid=1158021320&single=true&output=csv";

function todayISO(){
  return new Date().toISOString().split("T")[0];
}

function parseCSV(text){
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(row=>{
    const values = row.split(",");
    let obj = {};
    headers.forEach((h,i)=> obj[h.trim()] = values[i]?.trim());
    return obj;
  });
}

let allData = [];

function render(data){
  const list = document.getElementById("recordsList");
  list.innerHTML = "";
  let totalCollected = 0;
  const today = todayISO();

  const summary = {};

  data.forEach(row=>{
    const status = row["Status"] || "ACTIVE";
    if(status === "INACTIVE") return;

    const name = row["Borrower Name"];
    if(!name) return;

    const loan = Number(row["Loan Amount"] || 0);
    const collected = Number(row["Collected Amount"] || 0);
    const date = row["Date"];

    if(!summary[name]){
      summary[name] = {
        lent: 0,
        collected: 0,
        paidToday: false
      };
    }

    if(loan > summary[name].lent){
      summary[name].lent = loan;
    }

    summary[name].collected += collected;
    totalCollected += collected;

    if(date === today && collected > 0){
      summary[name].paidToday = true;
    }
  });

  Object.entries(summary).forEach(([name,info])=>{
    const balance = info.lent - info.collected;
    const paidToday = info.paidToday;

    const div = document.createElement("div");
    div.className = "list-item " + (paidToday ? "paid" : "not-paid");

    div.innerHTML = `
      <span>
        <strong>${name}</strong>
        ${
          paidToday
            ? '<span class="badge badge-green">PAID TODAY</span>'
            : '<span class="badge badge-red">NOT PAID TODAY</span>'
        }
        <br>
        <span class="small">
          Outstanding: ₹${balance.toFixed(2)}
        </span>
      </span>
      <strong>₹${info.collected.toFixed(2)}</strong>
    `;

    list.appendChild(div);
  });

  document.getElementById("totalAmount").textContent =
    "₹" + totalCollected.toFixed(2);
}

function applyFilters(){
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const borrower = document.getElementById("borrower").value.toLowerCase();

  const filtered = allData.filter(row=>{
    if(from && row["Date"] < from) return false;
    if(to && row["Date"] > to) return false;
    if(borrower && !row["Borrower Name"].toLowerCase().includes(borrower)) return false;
    return true;
  });

  render(filtered);
}

function resetFilters(){
  document.getElementById("fromDate").value = "";
  document.getElementById("toDate").value = "";
  document.getElementById("borrower").value = "";
  render(allData);
}

function exportCSV(){
  let csv = "Borrower,Outstanding,Paid Today\n";
  const today = todayISO();
  const summary = {};

  allData.forEach(r=>{
    const name = r["Borrower Name"];
    if(!name) return;

    const loan = Number(r["Loan Amount"] || 0);
    const collected = Number(r["Collected Amount"] || 0);
    const date = r["Date"];

    if(!summary[name]){
      summary[name] = { lent: 0, collected: 0, paidToday: false };
    }

    if(loan > summary[name].lent){
      summary[name].lent = loan;
    }
    summary[name].collected += collected;

    if(date === today && collected > 0){
      summary[name].paidToday = true;
    }
  });

  Object.entries(summary).forEach(([name,info])=>{
    csv += `${name},${info.lent - info.collected},${info.paidToday ? "YES" : "NO"}\n`;
  });

  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "jyotiba_daily_status.csv";
  a.click();
}

fetch(SHEET_URL)
  .then(res => res.text())
  .then(csv => {
    allData = parseCSV(csv);
    render(allData);
  });
</script>

</body>
</html>
