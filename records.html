<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Records – Jyotiba Finance Group</title>

<style>
body{
  margin:0;
  font-family: system-ui, Arial, sans-serif;
  background:#f4f6f8;
}
header{
  background:#1565c0;
  color:#fff;
  padding:14px;
  text-align:center;
  font-size:20px;
  font-weight:700;
}
.container{
  padding:14px;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
}
input{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-bottom:8px;
}
.btn{
  display:inline-block;
  padding:8px 12px;
  border-radius:10px;
  background:#1565c0;
  color:#fff;
  text-decoration:none;
  font-weight:600;
  margin-right:6px;
}
.row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.list-item{
  display:flex;
  justify-content:space-between;
  padding:10px 0;
  border-bottom:1px solid #eee;
}

/* ---- Overdue styles ---- */
.overdue{
  background:#fff4f4;
  border-left:5px solid #d32f2f;
  padding-left:8px;
}
.balance{
  font-weight:700;
}
.overdue .balance{
  color:#d32f2f;
}

/* ---- Badges ---- */
.badge{
  display:inline-block;
  padding:2px 8px;
  font-size:11px;
  border-radius:10px;
  margin-left:6px;
}
.badge-overdue{
  background:#d32f2f;
  color:#fff;
}
.badge-clear{
  background:#2e7d32;
  color:#fff;
}

.small{
  color:#666;
  font-size:14px;
}
.total{
  font-size:22px;
  font-weight:700;
  color:#1565c0;
}
</style>
</head>

<body>

<header>Jyotiba Finance Group</header>

<div class="container">

  <!-- Filters -->
  <div class="card">
    <div class="small">Filters</div>

    <input type="date" id="fromDate">
    <input type="date" id="toDate">
    <input type="text" id="borrower" placeholder="Borrower name">

    <div class="row">
      <button class="btn" onclick="applyFilters()">Apply</button>
      <button class="btn" onclick="resetFilters()">Reset</button>
      <button class="btn" onclick="exportCSV()">Export CSV</button>
      <a class="btn" href="index.html">⬅ Dashboard</a>
    </div>
  </div>

  <!-- Total -->
  <div class="card">
    <div class="small">Total Collected (Filtered)</div>
    <div id="totalAmount" class="total">₹0</div>
  </div>

  <!-- Records -->
  <div class="card">
    <div class="small">Borrower Summary</div>
    <div id="recordsList"></div>
  </div>

</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRHMVetLYoyRzDg57nOm2drb4pSyw33hqNsOTI9F92rD7bnk2p7sUypioSdhSNH_zcGO75kmsBKM5VI/pub?gid=1158021320&single=true&output=csv";
let allData = [];

function parseCSV(text){
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(row=>{
    const values = row.split(",");
    let obj = {};
    headers.forEach((h,i)=> obj[h.trim()] = values[i]?.trim());
    return obj;
  });
}

function render(data){
  const list = document.getElementById("recordsList");
  list.innerHTML = "";
  let totalCollected = 0;

  if(data.length === 0){
    list.innerHTML = "<div class='small'>No records found</div>";
    document.getElementById("totalAmount").textContent = "₹0";
    return;
  }

  const summary = {};

  data.forEach(row=>{
    const name = row["Borrower Name"] || "Unknown";
    const loanAmt = Number(row["Loan Amount"] || 0);
    const collectedAmt = Number(row["Collected Amount"] || 0);

    if(!summary[name]){
      summary[name] = { lent: 0, collected: 0 };
    }

    if(loanAmt > summary[name].lent){
      summary[name].lent = loanAmt;
    }

    summary[name].collected += collectedAmt;
    totalCollected += collectedAmt;
  });

  Object.entries(summary).forEach(([name,info])=>{
    const balance = info.lent - info.collected;
    const isOverdue = balance > 0;

    const div = document.createElement("div");
    div.className = "list-item" + (isOverdue ? " overdue" : "");

    div.innerHTML = `
      <span>
        <strong>${name}</strong>
        ${
          isOverdue
            ? '<span class="badge badge-overdue">OVERDUE</span>'
            : '<span class="badge badge-clear">CLEARED</span>'
        }
        <br>
        <span class="small">
          Lent: ₹${info.lent.toFixed(2)} |
          Collected: ₹${info.collected.toFixed(2)} |
          Balance: <span class="balance">₹${balance.toFixed(2)}</span>
        </span>
      </span>
      <strong>₹${info.collected.toFixed(2)}</strong>
    `;

    list.appendChild(div);
  });

  document.getElementById("totalAmount").textContent =
    "₹" + totalCollected.toFixed(2);
}

function applyFilters(){
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const borrower = document.getElementById("borrower").value.toLowerCase();

  const filtered = allData.filter(row=>{
    if(from && row["Date"] < from) return false;
    if(to && row["Date"] > to) return false;
    if(borrower && !row["Borrower Name"].toLowerCase().includes(borrower)) return false;
    return true;
  });

  render(filtered);
}

function resetFilters(){
  document.getElementById("fromDate").value = "";
  document.getElementById("toDate").value = "";
  document.getElementById("borrower").value = "";
  render(allData);
}

function exportCSV(){
  let csv = "Borrower,Loan Amount,Total Collected,Outstanding\n";
  const summary = {};

  allData.forEach(r=>{
    const name = r["Borrower Name"] || "Unknown";
    const loan = Number(r["Loan Amount"] || 0);
    const collected = Number(r["Collected Amount"] || 0);

    if(!summary[name]){
      summary[name] = { lent: 0, collected: 0 };
    }
    if(loan > summary[name].lent){
      summary[name].lent = loan;
    }
    summary[name].collected += collected;
  });

  Object.entries(summary).forEach(([name,info])=>{
    csv += `${name},${info.lent},${info.collected},${info.lent - info.collected}\n`;
  });

  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "jyotiba_finance_summary.csv";
  a.click();
}

fetch(SHEET_URL)
  .then(res => res.text())
  .then(csv => {
    allData = parseCSV(csv);
    render(allData);
  });
</script>

</body>
</html>
